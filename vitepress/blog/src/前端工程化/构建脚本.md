# 构建脚本

> 前端工程化有很多场景是需要编写脚本来实现特定的功能，下面列举一些场景和脚本

## monorepo 模式下构建指定的 packages

> 在根目录的 ci.yaml 文件通过指定 packages 属性来构建指定的子包，多子包用逗号分隔； 如果没有指定，则构建所有的子包，并把构建产物拷贝到根目录 dist 目录下的子包同名文件夹中；

- 1、在根目录创建 build.sh 文件
```sh
#!/bin/bash
set -e

# 从 ci.yaml 文件中提取 packages 属性的值
packages=$(grep 'packages:' ci.yaml | sed 's/packages: //')

# 检查是否成功提取到 packages 属性的值
if [ -z "$packages" ]; then
    echo "未在 ci.yaml 文件中找到 packages 属性或其值为空，将构建 packages 目录下的所有子项目。"
    # 获取 packages 目录下的所有子目录
    package_array=($(ls -d packages/*/ | sed 's/packages\///;s/\///'))
else
    # 将包名用逗号分隔成数组
    IFS=',' read -ra package_array <<< "$packages"
fi

# 创建项目根目录的 dist 文件夹
if [ -d "dist" ]; then
    rm -r dist
fi

mkdir -p dist

params="$@"

# 遍历每个包并执行构建命令
for package in "${package_array[@]}"; do
    package_dir="packages/$package"
    if [ -d "$package_dir" ]; then
        echo "正在构建包: $package"
        (cd "$package_dir" && pnpm run build -- $params) # 传递参数

        # 检查子项目的 dist 文件夹是否存在
        sub_dist_dir="$package_dir/dist"
        if [ -d "$sub_dist_dir" ]; then
            # 创建项目根目录 dist 下的子项目同名文件夹
            root_dist_sub_dir="dist/$package"
            mkdir -p "$root_dist_sub_dir"

            # 拷贝子项目 dist 下的所有文件到项目根目录 dist 下的同名文件夹
            cp -r "$sub_dist_dir/"* "$root_dist_sub_dir/"
            echo "已将 $package 的 dist 文件拷贝到 $root_dist_sub_dir"
        else
            echo "包 $package 的 dist 目录不存在，跳过拷贝操作。"
        fi
    else
        echo "包目录 $package_dir 不存在。"
    fi
done
```
- 2、添加执行权限
```sh
chmod +x build.sh
```
- 3、根目录 package.json 中添加 script
```sh
"build:ci": "sh ./build.sh",
```
- 4、根目录创建 ci.yaml 文件， packages的值根据实际情况修改
```sh
packages: package1,package2
```
- 5、执行构建命令
```sh
pnpm run build:ci
```